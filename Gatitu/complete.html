<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCEA Gatitu Church - Growing in Faith, Serving in Love</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #6b8cbc;
            --accent: #ff6b6b;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo h1 {
            font-size: 1.5rem;
        }
        
        .logo-icon {
            font-size: 2rem;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        nav a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--accent);
            color: white;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid white;
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Welcome Section with Cover Page */
        .cover-section {
            position: relative;
            height: 80vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .cover-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                
                url('cover.jpg') no-repeat center center/cover;
        }
        
        .welcome-message {
            position: relative;
            z-index: 2;
            color: white;
            text-align: center;
            font-size: 3rem;
            font-weight: 700;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            animation: fadeIn 2s ease-in-out;
        }
        
        .church-theme {
            position: relative;
            z-index: 2;
            color: white;
            text-align: center;
            font-size: 1.5rem;
            margin-top: 20px;
            font-style: italic;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Notification Bar */
        .notification-bar {
            background-color: var(--warning);
            color: var(--dark);
            padding: 12px 0;
            text-align: center;
            font-weight: 500;
            font-size: 1rem;
        }
        
        /* Main Content */
        .main-content {
            padding: 40px 0;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
            position: relative;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background-color: var(--accent);
        }
        
        /* Photo Galleries */
        .gallery-section {
            margin-bottom: 40px;
        }
        
        .gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .gallery-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            height: 200px;
            background-color: #e9ecef;
        }
        
        .gallery-item:hover {
            transform: translateY(-5px);
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Announcements Section */
        .announcements {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .announcement-item {
            padding: 15px;
            border-left: 4px solid var(--primary);
            margin-bottom: 15px;
            background-color: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }
        
        .announcement-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .announcement-date {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        /* Activities Section */
        .activities {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .activity-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        
        .activity-card:hover {
            transform: translateY(-5px);
        }
        
        .activity-header {
            padding: 15px;
            color: white;
            font-weight: 600;
        }
        
        .ongoing .activity-header {
            background-color: var(--info);
        }
        
        .completed .activity-header {
            background-color: var(--success);
        }
        
        .upcoming .activity-header {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .activity-body {
            padding: 15px;
        }
        
        .activity-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        /* Blog Section */
        .blog-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .blog-post {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .blog-title {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .blog-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .blog-content {
            margin-bottom: 15px;
        }
        
        .comments-section {
            margin-top: 20px;
        }
        
        .comment {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .comment-author {
            font-weight: 600;
            color: var(--primary);
        }
        
        .comment-date {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        /* Community Chat */
        .community-chat {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.sent {
            background-color: #e3f2fd;
            margin-left: auto;
        }
        
        .message.received {
            background-color: #f5f5f5;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }
        
        /* Financial Section */
        .financial-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .financial-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* Footer */
        footer {
            background-color: var(--dark);
            color: white;
            padding: 40px 0 20px;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .footer-section h3 {
            margin-bottom: 20px;
            color: var(--accent);
        }
        
        .footer-section ul {
            list-style: none;
        }
        
        .footer-section ul li {
            margin-bottom: 10px;
        }
        
        .footer-section a {
            color: #adb5bd;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .footer-section a:hover {
            color: white;
        }
        
        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #495057;
            color: #adb5bd;
            font-size: 0.9rem;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        /* User Profile */
        .user-profile {
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background-size: cover;
            background-position: center;
        }

        /* Admin Access */
        .admin-access {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .admin-access h2 {
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .admin-access p {
            margin-bottom: 20px;
            color: #6c757d;
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            cursor: pointer;
            margin-right: 15px;
        }
        
        .notification-bell i {
            font-size: 1.5rem;
            color: white;
        }
        
        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 360px;
            max-width: 90vw;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
        }
        
        .notification-item:hover {
            background-color: #f8f9fa;
        }
        
        .notification-item.unread {
            background-color: #e7f3ff;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .notification-time {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* Login Required Message */
        .login-required {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Alert Messages */
        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Profile Photo Button */
        .btn-pink {
            background-color: #e91e63;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-pink:hover {
            background-color: #c2185b;
            transform: translateY(-2px);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .welcome-message {
                font-size: 2rem;
            }
            
            .church-theme {
                font-size: 1.2rem;
            }
            
            .activities {
                grid-template-columns: 1fr;
            }
            
            .gallery-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .notification-dropdown {
                width: 300px;
                right: -50px;
            }
        }

        .notification-item .notification-message {
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 6px;
        }
        
        .notification-dropdown {
            padding: 10px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">â›ª</div>
                    <h1>PCEA Gatitu Church</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="#home">Home</a></li>
                        <li><a href="#announcements">Announcements</a></li>
                        <li><a href="#activities">Activities</a></li>
                        <li><a href="#gallery">Gallery</a></li>
                        <li><a href="#blog">Blog</a></li>
                        <li><a href="#community">Community</a></li>
                    </ul>
                </nav>
                <div class="auth-buttons" id="authButtons">
                    <button class="btn btn-outline" id="loginBtn">Login</button>
                    <button class="btn btn-primary" id="registerBtn">Register</button>
                </div>
                <div class="user-profile" id="userProfile">
                    <div class="notification-bell" id="notificationBell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count" id="notificationCount">0</span>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <!-- Notifications will be loaded here -->
                        </div>
                    </div>
                    <div class="user-avatar" id="userAvatar" style="cursor: pointer;" title="View Profile">U</div>
                    <span id="userName">User</span>
                    <button class="btn btn-outline" id="logoutBtn">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Welcome Section with Cover Page -->
    <section class="cover-section" id="home">
        <div class="cover-image"></div>
        <div class="container">
            <h1 class="welcome-message" id="welcomeText">WELCOME TO PCEA GATITU CHURCH</h1>
            <div class="church-theme">"Growing in Faith, Serving in Love"</div>
        </div>
    </section>

    <!-- Notification Bar -->
    <div class="notification-bar">
        <div class="container">
            <p id="serviceNotification">The service on Sunday starts at 8:30 AM</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Admin Access Section -->
            <section class="admin-access">
                <h2>Church Administration</h2>
                <p>Authorized personnel can access the admin panel to manage website content</p>
                <a href="completeprivate.html" class="btn btn-success">
                    <i class="fas fa-cog"></i> Access Admin Panel
                </a>
            </section>

            <!-- Photo Galleries -->
            <section class="gallery-section" id="gallery">
                <h2 class="section-title">Church Gallery</h2>
                
                <h3 style="margin: 20px 0 10px; color: var(--primary);">Church Photos</h3>
                <div class="gallery-container" id="churchGallery">
                    <!-- Church photos will be loaded here -->
                </div>
                
                <h3 style="margin: 20px 0 10px; color: var(--primary);">Trips & Retreats</h3>
                <div class="gallery-container" id="tripsGallery">
                    <!-- Trip photos will be loaded here -->
                </div>
            </section>

            <!-- Announcements Section -->
            <section class="announcements" id="announcements">
                <h2 class="section-title">Latest Announcements</h2>
                <div class="announcement-list" id="announcementList">
                    <!-- Announcements will be loaded here -->
                </div>
            </section>

            <!-- Activities Section -->
            <section class="activities" id="activities">
                <h2 class="section-title" style="grid-column: 1 / -1;">Church Activities</h2>
                <div id="activitiesList">
                    <!-- Activities will be loaded here -->
                </div>
            </section>

            <!-- Blog Section -->
            <section class="blog-section" id="blog">
                <h2 class="section-title">Church Blog</h2>
                <div id="blogPosts">
                    <!-- Blog posts will be loaded here -->
                </div>
                <div id="blogLoginRequired" class="login-required" style="display: none;">
                    <h3>Login Required</h3>
                    <p>Please log in to view blog posts and comments</p>
                    <button class="btn btn-primary" id="blogLoginBtn">Login Now</button>
                </div>
            </section>

            <!-- Community Chat -->
            <section class="community-chat" id="community">
                <h2 class="section-title">Community Chat</h2>
                <div class="chat-messages" id="chatMessages">
                    <!-- Chat messages will be loaded here -->
                </div>
                <div id="chatLoginRequired" class="login-required" style="display: none;">
                    <h3>Login Required</h3>
                    <p>Please log in to participate in community chat</p>
                    <button class="btn btn-primary" id="chatLoginBtn">Login Now</button>
                </div>
                <div class="chat-input" id="chatInputArea" style="display: none;">
                    <input type="text" id="chatInput" placeholder="Type your message...">
                    <button class="btn btn-primary" id="sendMessageBtn">Send</button>
                </div>
            </section>

            <!-- Financial Section -->
            <section class="financial-section">
                <h2 class="section-title">Financial Updates</h2>
                <div class="financial-stats" id="financialStats">
                    <!-- Financial stats will be loaded here -->
                </div>
                <p>These funds will be used for our upcoming mission trip and community outreach programs. Thank you for your generous contributions!</p>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>About Us</h3>
                    <p>The PCEA Gatitu Church is a vibrant community of Christians dedicated to growing in faith and serving our community.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#home">Home</a></li>
                        <li><a href="#announcements">Announcements</a></li>
                        <li><a href="#activities">Activities</a></li>
                        <li><a href="#gallery">Gallery</a></li>
                        <li><a href="#blog">Blog</a></li>
                        <li><a href="#community">Community</a></li>
                        <li><a href="admin.html">Admin Panel</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <ul>
                        <li>Email: info@pceagatitu.org</li>
                        <li>Phone: +254 712 345 678</li>
                        <li>Address: PCEA Gatitu Church, Nyeri</li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 PCEA Gatitu Church. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Login to Your Account</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div id="loginAlerts"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
            <div style="text-align: center; margin-top: 15px;">
                <a href="#" id="forgotPasswordLink" style="color: var(--primary); text-decoration: none;">Forgot Password?</a>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create an Account</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div id="registerAlerts"></div>
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="registerPhone">Phone Number</label>
                    <input type="tel" id="registerPhone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
            </form>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Reset Password</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div id="forgotPasswordAlerts"></div>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="resetEmail">Email Address</label>
                    <input type="email" id="resetEmail" class="form-control" required placeholder="Enter your email address">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Send Reset Link</button>
            </form>
            <div style="text-align: center; margin-top: 15px;">
                <p><small>A password reset link will be sent to your email. This tab will remain open until you close it.</small></p>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">My Profile</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div id="profileAlerts"></div>
            <div class="form-group text-center">
                <div class="user-avatar-large" id="userAvatarLarge" style="width: 100px; height: 100px; margin: 0 auto 20px; background-size: cover; background-position: center; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer;">
                    U
                </div>
                <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;">
                <button class="btn-pink" id="changePhotoBtn">
                    <i class="fas fa-upload"></i> Upload New Photo
                </button>
            </div>
            <form id="profileForm">
                <div class="form-group">
                    <label for="profileName">Full Name</label>
                    <input type="text" id="profileName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="profileEmail">Email Address</label>
                    <input type="email" id="profileEmail" class="form-control" required readonly>
                </div>
                <div class="form-group">
                    <label for="profilePhone">Phone Number</label>
                    <input type="tel" id="profilePhone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="currentPassword">Current Password (to make changes)</label>
                    <input type="password" id="currentPassword" class="form-control">
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password (optional)</label>
                    <input type="password" id="newPassword" class="form-control">
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">Confirm New Password</label>
                    <input type="password" id="confirmNewPassword" class="form-control">
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Update Profile</button>
            </form>
        </div>
    </div>

    <script>
        const EMAILJS_PUBLIC_KEY = 'HTfV11I7uCkibzBPb';
        const EMAILJS_SERVICE_ID = 'service_e4qdh31';
        const EMAILJS_TEMPLATE_ID = 'template_76s5w2r';

        
       

        // Initialize data if not exists
        function initializeData() {
            if (!localStorage.getItem('pcea_users')) {
                localStorage.setItem('pcea_users', JSON.stringify([]));
            }
            if (!localStorage.getItem('pcea_announcements')) {
                const defaultAnnouncements = [
                    {
                        id: 1,
                        title: "Welcome to PCEA Gatitu Church",
                        content: "We welcome all members to our church community. Join us for fellowship and spiritual growth.",
                        date: new Date().toISOString().split('T')[0],
                        author: "Admin"
                    }
                ];
                localStorage.setItem('pcea_announcements', JSON.stringify(defaultAnnouncements));
            }
            if (!localStorage.getItem('pcea_activities')) {
                const defaultActivities = [
                    {
                        id: 1,
                        title: "Sunday Service",
                        description: "Join us every Sunday for worship and fellowship. Service starts at 8:30 AM.",
                        type: "ongoing",
                        date: new Date().toISOString().split('T')[0]
                    }
                ];
                localStorage.setItem('pcea_activities', JSON.stringify(defaultActivities));
            }
            if (!localStorage.getItem('pcea_blogPosts')) {
                localStorage.setItem('pcea_blogPosts', JSON.stringify([]));
            }
            if (!localStorage.getItem('pcea_chatMessages')) {
                localStorage.setItem('pcea_chatMessages', JSON.stringify([]));
            }
            if (!localStorage.getItem('pcea_churchPhotos')) {
                localStorage.setItem('pcea_churchPhotos', JSON.stringify([]));
            }
            if (!localStorage.getItem('pcea_tripPhotos')) {
                localStorage.setItem('pcea_tripPhotos', JSON.stringify([]));
            }
            if (!localStorage.getItem('pcea_finances')) {
                const defaultFinances = {
                    offering: 0,
                    donations: 0,
                    expenses: 0
                };
                localStorage.setItem('pcea_finances', JSON.stringify(defaultFinances));
            }
            if (!localStorage.getItem('pcea_notifications')) {
                localStorage.setItem('pcea_notifications', JSON.stringify([]));
            }
        }

        // Data storage
        let users = [];
        let announcements = [];
        let activities = [];
        let blogPosts = [];
        let chatMessages = [];
        let churchPhotos = [];
        let tripPhotos = [];
        let finances = {};
        let notifications = [];
        let currentUser = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {

            // Initialize EmailJS
            emailjs.init(EMAILJS_PUBLIC_KEY);
            // Initialize data
            initializeData();
            
            // Load data from localStorage
            loadAllData();
            
            // Welcome message animation
            const welcomeText = document.getElementById('welcomeText');
            welcomeText.style.opacity = '0';
            welcomeText.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                welcomeText.style.transition = 'opacity 2s, transform 2s';
                welcomeText.style.opacity = '1';
                welcomeText.style.transform = 'translateY(0)';
            }, 500);
            
            // Service notification based on day of week
            updateServiceNotification();
            
            // Load all content
            loadGalleryPhotos();
            loadAnnouncements();
            loadActivities();
            loadBlogPosts();
            loadChatMessages();
            loadFinancialStats();
            loadNotifications();
            
            // Check if user is logged in
            checkLoginStatus();
            
            // Modal functionality
            setupModals();
            
            // Chat functionality
            setupChat();
            
            // Notification bell functionality
            setupNotifications();
        });

        function loadAllData() {
            users = JSON.parse(localStorage.getItem('pcea_users')) || [];
            announcements = JSON.parse(localStorage.getItem('pcea_announcements')) || [];
            activities = JSON.parse(localStorage.getItem('pcea_activities')) || [];
            blogPosts = JSON.parse(localStorage.getItem('pcea_blogPosts')) || [];
            chatMessages = JSON.parse(localStorage.getItem('pcea_chatMessages')) || [];
            churchPhotos = JSON.parse(localStorage.getItem('pcea_churchPhotos')) || [];
            tripPhotos = JSON.parse(localStorage.getItem('pcea_tripPhotos')) || [];
            finances = JSON.parse(localStorage.getItem('pcea_finances')) || {};
            notifications = JSON.parse(localStorage.getItem('pcea_notifications')) || [];
            currentUser = JSON.parse(localStorage.getItem('pcea_currentUser')) || null;
        }

        function updateServiceNotification() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const notification = document.getElementById('serviceNotification');
            
            if (dayOfWeek === 0) {
                notification.innerHTML = "Today's service starts at 8:30 AM. We look forward to worshiping with you!";
            } else {
                const daysUntilSunday = 7 - dayOfWeek;
                notification.innerHTML = `The service on Sunday starts at 8:30 AM. ${daysUntilSunday} day${daysUntilSunday !== 1 ? 's' : ''} until next Sunday!`;
            }
        }

        function loadGalleryPhotos() {
            const churchGallery = document.getElementById('churchGallery');
            const tripsGallery = document.getElementById('tripsGallery');
            
            churchGallery.innerHTML = '';
            tripsGallery.innerHTML = '';
            
            // Load church photos
            churchPhotos.forEach(photo => {
                const galleryItem = document.createElement('div');
                galleryItem.className = 'gallery-item';
                galleryItem.innerHTML = `<img src="${photo.url}" alt="${photo.alt}" loading="lazy">`;
                churchGallery.appendChild(galleryItem);
            });
            
            // Load trip photos
            tripPhotos.forEach(photo => {
                const galleryItem = document.createElement('div');
                galleryItem.className = 'gallery-item';
                galleryItem.innerHTML = `<img src="${photo.url}" alt="${photo.alt}" loading="lazy">`;
                tripsGallery.appendChild(galleryItem);
            });

            // Show empty state if no photos
            if (churchPhotos.length === 0) {
                churchGallery.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;"><i class="fas fa-images" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #dee2e6;"></i><h4>No church photos yet</h4><p>Check back later for updates</p></div>';
            }
            if (tripPhotos.length === 0) {
                tripsGallery.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;"><i class="fas fa-images" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #dee2e6;"></i><h4>No trip photos yet</h4><p>Check back later for updates</p></div>';
            }
        }

        function loadAnnouncements() {
            const announcementList = document.getElementById('announcementList');
            announcementList.innerHTML = '';
            
            if (announcements.length === 0) {
                announcementList.innerHTML = '<div class="empty-state" style="text-align: center; padding: 40px; color: #6c757d;"><i class="fas fa-bullhorn" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #dee2e6;"></i><h4>No announcements yet</h4><p>Check back later for updates</p></div>';
                return;
            }
            
            announcements.forEach(announcement => {
                const announcementItem = document.createElement('div');
                announcementItem.className = 'announcement-item';
                announcementItem.innerHTML = `
                    <h3 class="announcement-title">${announcement.title}</h3>
                    <div class="announcement-date">Posted on: ${formatDate(announcement.date)} by ${announcement.author}</div>
                    <p>${announcement.content}</p>
                `;
                announcementList.appendChild(announcementItem);
            });
        }

        function loadActivities() {
            const activitiesList = document.getElementById('activitiesList');
            activitiesList.innerHTML = '';
            
            if (activities.length === 0) {
                activitiesList.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;"><i class="fas fa-calendar-alt" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #dee2e6;"></i><h4>No activities scheduled</h4><p>Check back later for updates</p></div>';
                return;
            }
            
            activities.forEach(activity => {
                const activityCard = document.createElement('div');
                activityCard.className = `activity-card ${activity.type}`;
                activityCard.innerHTML = `
                    <div class="activity-header">${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)}</div>
                    <div class="activity-body">
                        <h3 class="activity-title">${activity.title}</h3>
                        <p>${activity.description}</p>
                        <small>Date: ${formatDate(activity.date)}</small>
                    </div>
                `;
                activitiesList.appendChild(activityCard);
            });
        }

        function loadBlogPosts() {
            const blogPostsContainer = document.getElementById('blogPosts');
            const blogLoginRequired = document.getElementById('blogLoginRequired');
            
            if (!currentUser) {
                blogPostsContainer.style.display = 'none';
                blogLoginRequired.style.display = 'block';
                return;
            }
            
            blogPostsContainer.style.display = 'block';
            blogLoginRequired.style.display = 'none';
            blogPostsContainer.innerHTML = '';
            
            if (blogPosts.length === 0) {
                blogPostsContainer.innerHTML = '<div class="empty-state" style="text-align: center; padding: 40px; color: #6c757d;"><i class="fas fa-blog" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #dee2e6;"></i><h4>No blog posts yet</h4><p>Check back later for updates</p></div>';
                return;
            }
            
            blogPosts.forEach(post => {
                const blogPost = document.createElement('div');
                blogPost.className = 'blog-post';
                blogPost.innerHTML = `
                    <h3 class="blog-title">${post.title}</h3>
                    <div class="blog-meta">
                        <span class="blog-author">By ${post.author}</span>
                        <span class="blog-date">${formatDate(post.date)}</span>
                    </div>
                    <div class="blog-content">
                        <p>${post.content}</p>
                    </div>
                    <div class="comments-section">
                        <h4>Comments (${post.comments.length})</h4>
                        ${post.comments.map(comment => `
                            <div class="comment">
                                <div class="comment-header">
                                    <span class="comment-author">${comment.author}</span>
                                    <span class="comment-date">${formatDate(comment.date)}</span>
                                </div>
                                <p>${comment.content}</p>
                            </div>
                        `).join('')}
                        <div class="comment-form">
                            <h4>Add a Comment</h4>
                            <div class="form-group">
                                <textarea class="form-control comment-text" placeholder="Write your comment..." rows="3"></textarea>
                            </div>
                            <button class="btn btn-primary add-comment-btn" data-post-id="${post.id}">Post Comment</button>
                        </div>
                    </div>
                `;
                blogPostsContainer.appendChild(blogPost);
            });

            // Add event listeners for comment buttons
            document.querySelectorAll('.add-comment-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const postId = parseInt(this.getAttribute('data-post-id'));
                    const commentText = this.closest('.comment-form').querySelector('.comment-text').value;
                    
                    if (commentText.trim() && currentUser) {
                        addComment(postId, commentText);
                        this.closest('.comment-form').querySelector('.comment-text').value = '';
                    }
                });
            });
        }

        function addComment(postId, commentText) {
            const post = blogPosts.find(p => p.id === postId);
            if (post) {
                const newComment = {
                    author: currentUser.name,
                    date: new Date().toISOString().split('T')[0],
                    content: commentText
                };
                
                post.comments.push(newComment);
                localStorage.setItem('pcea_blogPosts', JSON.stringify(blogPosts));
                
                // Add notification for new comment (only for other users)
                users.forEach(user => {
                    if (user.email !== currentUser.email) {
                        addNotification(
                            'New Comment', 
                            `${currentUser.name} commented on "${post.title}"`, 
                            'blog',
                            user.email
                        );
                    }
                });
                
                loadBlogPosts();
            }
        }

        function loadChatMessages() {
            const chatMessagesContainer = document.getElementById('chatMessages');
            const chatLoginRequired = document.getElementById('chatLoginRequired');
            const chatInputArea = document.getElementById('chatInputArea');
            
            chatMessagesContainer.innerHTML = '';
            
            if (!currentUser) {
                chatLoginRequired.style.display = 'block';
                chatInputArea.style.display = 'none';
                
                const loginMessage = document.createElement('div');
                loginMessage.className = 'message received';
                loginMessage.innerHTML = `<strong>System:</strong> Please log in to view and participate in community chat`;
                chatMessagesContainer.appendChild(loginMessage);
                return;
            }
            
            chatLoginRequired.style.display = 'none';
            chatInputArea.style.display = 'flex';
            
            if (chatMessages.length === 0) {
                const welcomeMessage = document.createElement('div');
                welcomeMessage.className = 'message received';
                welcomeMessage.innerHTML = `<strong>System:</strong> Welcome to PCEA Gatitu Church community chat! Start a conversation with fellow members.`;
                chatMessagesContainer.appendChild(welcomeMessage);
            } else {
                chatMessages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    const isCurrentUser = msg.user === currentUser.name;
                    messageElement.className = isCurrentUser ? 'message sent' : 'message received';
                    messageElement.innerHTML = `<strong>${msg.user}:</strong> ${msg.message} <small style="display: block; font-size: 0.7rem; color: #6c757d;">${msg.time}</small>`;
                    chatMessagesContainer.appendChild(messageElement);
                });
            }
            
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function loadFinancialStats() {
            const financialStats = document.getElementById('financialStats');
            financialStats.innerHTML = '';
            
            let stats = [];
            
            if (!currentUser) {
                // Show zero for non-logged in users
                stats = [
                    { label: 'Total Offering', value: 'KSh 0' },
                    { label: 'Total Donations', value: 'KSh 0' },
                    { label: 'Expenses', value: 'KSh 0' },
                    { label: 'Available Funds', value: 'KSh 0' }
                ];
            } else {
                const totalFunds = (finances.offering || 0) + (finances.donations || 0) - (finances.expenses || 0);
                
                stats = [
                    { label: 'Total Offering', value: `KSh ${(finances.offering || 0).toLocaleString()}` },
                    { label: 'Total Donations', value: `KSh ${(finances.donations || 0).toLocaleString()}` },
                    { label: 'Expenses', value: `KSh ${(finances.expenses || 0).toLocaleString()}` },
                    { label: 'Available Funds', value: `KSh ${totalFunds.toLocaleString()}` }
                ];
            }
            
            stats.forEach(stat => {
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                `;
                financialStats.appendChild(statCard);
            });
        }

        function checkLoginStatus() {
            const authButtons = document.getElementById('authButtons');
            const userProfile = document.getElementById('userProfile');
            const userName = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');
            
            if (currentUser) {
                authButtons.style.display = 'none';
                userProfile.style.display = 'flex';
                userName.textContent = currentUser.name;
                
                // Set avatar
                if (currentUser.avatar) {
                    userAvatar.style.backgroundImage = `url(${currentUser.avatar})`;
                    userAvatar.textContent = '';
                } else {
                    userAvatar.style.backgroundImage = 'none';
                    userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
                }
                
                // Reload content that requires login
                loadBlogPosts();
                loadChatMessages();
                loadFinancialStats();
            } else {
                authButtons.style.display = 'flex';
                userProfile.style.display = 'none';
                
                // Hide content that requires login
                loadBlogPosts();
                loadChatMessages();
                loadFinancialStats();
            }
        }

        function setupModals() {
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userAvatar = document.getElementById('userAvatar');
            const blogLoginBtn = document.getElementById('blogLoginBtn');
            const chatLoginBtn = document.getElementById('chatLoginBtn');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            const forgotPasswordModal = document.getElementById('forgotPasswordModal');
            const profileModal = document.getElementById('profileModal');
            
            const closeButtons = document.querySelectorAll('.close-modal');
            
            loginBtn.addEventListener('click', () => {
                clearAlerts('loginAlerts');
                loginModal.style.display = 'flex';
            });
            
            registerBtn.addEventListener('click', () => {
                clearAlerts('registerAlerts');
                registerModal.style.display = 'flex';
            });
            
            blogLoginBtn.addEventListener('click', () => {
                clearAlerts('loginAlerts');
                loginModal.style.display = 'flex';
            });
            
            chatLoginBtn.addEventListener('click', () => {
                clearAlerts('loginAlerts');
                loginModal.style.display = 'flex';
            });
            
            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                clearAlerts('forgotPasswordAlerts');
                loginModal.style.display = 'none';
                forgotPasswordModal.style.display = 'flex';
            });
            
            userAvatar.addEventListener('click', () => {
                if (currentUser) {
                    clearAlerts('profileAlerts');
                    loadProfileModal();
                    profileModal.style.display = 'flex';
                }
            });
            
            logoutBtn.addEventListener('click', () => {
                currentUser = null;
                localStorage.removeItem('pcea_currentUser');
                checkLoginStatus();
                showAlert('loginAlerts', 'You have been logged out successfully.', 'success');
            });
            
            closeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    loginModal.style.display = 'none';
                    registerModal.style.display = 'none';
                    // Don't auto-close forgot password modal
                    if (button.closest('.modal') !== forgotPasswordModal) {
                        forgotPasswordModal.style.display = 'none';
                    }
                    profileModal.style.display = 'none';
                });
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === loginModal) loginModal.style.display = 'none';
                if (e.target === registerModal) registerModal.style.display = 'none';
                // Don't close forgot password modal when clicking outside
                if (e.target === profileModal) profileModal.style.display = 'none';
            });
            
            // Login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                // Check if admin login
                if (email === 'admin@pceagatitu.org' && password === 'admin123') {
                    // Redirect to admin panel
                    window.location.href = 'admin.html';
                    return;
                }
                
                // Check regular user login
                const user = users.find(u => u.email === email && u.password === password);
                
                if (user) {
                    currentUser = user;
                    localStorage.setItem('pcea_currentUser', JSON.stringify(currentUser));
                    checkLoginStatus();
                    loginModal.style.display = 'none';
                    document.getElementById('loginForm').reset();
                    showAlert('loginAlerts', `Login successful! Welcome back, ${user.name}`, 'success');
                } else {
                    showAlert('loginAlerts', 'Invalid email or password. Please try again.', 'error');
                }
            });
            
            // Registration form submission
            document.getElementById('registerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const phone = document.getElementById('registerPhone').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                
                if (password !== confirmPassword) {
                    showAlert('registerAlerts', 'Passwords do not match. Please try again.', 'error');
                    return;
                }
                
                // Check if user already exists
                if (users.find(u => u.email === email)) {
                    showAlert('registerAlerts', 'An account with this email already exists. Please use a different email.', 'error');
                    return;
                }
                
                // Create new user
                const newUser = {
                    id: Date.now(),
                    name: name,
                    email: email,
                    phone: phone,
                    password: password,
                    avatar: null,
                    role: 'member',
                    registrationDate: new Date().toISOString().split('T')[0]
                };
                
                users.push(newUser);
                localStorage.setItem('pcea_users', JSON.stringify(users));
                
                currentUser = newUser;
                localStorage.setItem('pcea_currentUser', JSON.stringify(currentUser));
                
                checkLoginStatus();
                registerModal.style.display = 'none';
                document.getElementById('registerForm').reset();
                showAlert('registerAlerts', `Registration successful! Welcome to PCEA Gatitu Church, ${name}`, 'success');
            });
            
            // Forgot password form with real email service
            document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('resetEmail').value;
                const user = users.find(u => u.email === email);
                
                if (user) {
                    // Generate reset token
                    const resetToken = generateResetToken();
                    const resetLink = `${window.location.origin}/reset-password.html?token=${resetToken}&email=${encodeURIComponent(email)}`;
                    
                    // Store reset token temporarily (in a real app, you'd use a database)
                    localStorage.setItem(`pcea_reset_${email}`, resetToken);
                    
                    // Send email using EmailJS
                    const templateParams = {
                        to_email: email,
                        to_name: user.name,
                        reset_link: resetLink,
                        church_name: "PCEA Gatitu Church"
                    };

                    emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams)
                        .then(function(response) {
                            showAlert('forgotPasswordAlerts', 
                                `Password reset link has been sent to ${email}. Please check your email. 
                                <br><br><strong>PCEA Gatitu Church - "Growing in Faith, Serving in Love"</strong>
                                <br><br><em>This tab will remain open until you close it manually.</em>`, 
                                'success');
                        }, function(error) {
                            // Fallback: show the reset link directly (for testing)
                            showAlert('forgotPasswordAlerts', 
                                `Password reset link: <a href="${resetLink}" target="_blank">${resetLink}</a>
                                <br><br><strong>PCEA Gatitu Church - "Growing in Faith, Serving in Love"</strong>
                                <br><br><em>This tab will remain open until you close it manually.</em>`, 
                                'success');
                        });
                    
                } else {
                    showAlert('forgotPasswordAlerts', 
                        'No account found with this email address. Please check your email or create a new account.', 
                        'error');
                }
            });
            
            // Profile form submission
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateUserProfile();
            });
            
            // Profile photo change
            document.getElementById('changePhotoBtn').addEventListener('click', function() {
                document.getElementById('profilePhotoInput').click();
            });
            
            document.getElementById('profilePhotoInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const userAvatarLarge = document.getElementById('userAvatarLarge');
                        userAvatarLarge.style.backgroundImage = `url(${e.target.result})`;
                        userAvatarLarge.textContent = '';
                        
                        // Update current user avatar temporarily
                        currentUser.avatar = e.target.result;
                        checkLoginStatus();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function generateResetToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
            alert.innerHTML = message;
            container.innerHTML = '';
            container.appendChild(alert);
        }

        function clearAlerts(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function loadProfileModal() {
            if (!currentUser) return;
            
            document.getElementById('profileName').value = currentUser.name;
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('profilePhone').value = currentUser.phone;
            
            const userAvatarLarge = document.getElementById('userAvatarLarge');
            if (currentUser.avatar) {
                userAvatarLarge.style.backgroundImage = `url(${currentUser.avatar})`;
                userAvatarLarge.textContent = '';
            } else {
                userAvatarLarge.style.backgroundImage = 'none';
                userAvatarLarge.textContent = currentUser.name.charAt(0).toUpperCase();
            }
            
            // Clear password fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }

        function updateUserProfile() {
            const name = document.getElementById('profileName').value;
            const phone = document.getElementById('profilePhone').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            // Verify current password if making changes
            if ((name !== currentUser.name || phone !== currentUser.phone || newPassword) && currentPassword !== currentUser.password) {
                showAlert('profileAlerts', 'Current password is incorrect. Please enter your current password to make changes.', 'error');
                return;
            }
            
            // Check if new password matches confirmation
            if (newPassword && newPassword !== confirmNewPassword) {
                showAlert('profileAlerts', 'New passwords do not match.', 'error');
                return;
            }
            
            // Update user data
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].name = name;
                users[userIndex].phone = phone;
                users[userIndex].avatar = currentUser.avatar; // Use the temporarily stored avatar
                
                if (newPassword) {
                    users[userIndex].password = newPassword;
                }
                
                localStorage.setItem('pcea_users', JSON.stringify(users));
                
                // Update current user
                currentUser = users[userIndex];
                localStorage.setItem('pcea_currentUser', JSON.stringify(currentUser));
                
                checkLoginStatus();
                document.getElementById('profileModal').style.display = 'none';
                showAlert('profileAlerts', 'Profile updated successfully!', 'success');
            }
        }

        function setupChat() {
            const chatInput = document.getElementById('chatInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            
            sendMessageBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            function sendMessage() {
                const message = chatInput.value.trim();
                if (message && currentUser) {
                    const newMessage = {
                        user: currentUser.name,
                        message: message,
                        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                    };
                    
                    chatMessages.push(newMessage);
                    localStorage.setItem('pcea_chatMessages', JSON.stringify(chatMessages));
                    
                    // Add notification for new message (only for other users)
                    users.forEach(user => {
                        if (user.email !== currentUser.email) {
                            addNotification(
                                'New Chat Message', 
                                `${currentUser.name} sent a new message in community chat`, 
                                'chat',
                                user.email
                            );
                        }
                    });
                    
                    loadChatMessages();
                    chatInput.value = '';
                }
            }
        }

        function setupNotifications() {
            const notificationBell = document.getElementById('notificationBell');
            const notificationDropdown = document.getElementById('notificationDropdown');
            
            notificationBell.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationDropdown.style.display = notificationDropdown.style.display === 'block' ? 'none' : 'block';
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                notificationDropdown.style.display = 'none';
            });
        }

        function loadNotifications() {
            const notificationCount = document.getElementById('notificationCount');
            const notificationDropdown = document.getElementById('notificationDropdown');
            
            // Filter notifications for current user and exclude their own actions
            const userNotifications = notifications.filter(notification => {
                // Show notification if it's for this user or for everyone
                const isForUser = !notification.exclude || notification.exclude === currentUser?.email;
                // Don't show notifications about user's own actions
                const isNotOwnAction = !notification.message?.includes(currentUser?.name) || !currentUser;
                return isForUser && isNotOwnAction;
            });
            
            // Count unread notifications
            const unreadCount = userNotifications.filter(n => !n.read).length;
            notificationCount.textContent = unreadCount;
            notificationCount.style.display = unreadCount > 0 ? 'flex' : 'none';
            
            // Load notifications in dropdown
            notificationDropdown.innerHTML = '';
            
            const recentNotifications = userNotifications.slice(-20).reverse(); // Show up to 20 most recent
            
            if (recentNotifications.length === 0) {
                const noNotifications = document.createElement('div');
                noNotifications.className = 'notification-item';
                noNotifications.textContent = 'No notifications';
                notificationDropdown.appendChild(noNotifications);
            } else {
                recentNotifications.forEach(notification => {
                    const notificationItem = document.createElement('div');
                    notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
                    notificationItem.innerHTML = `
                        <div class="notification-title">${notification.title}</div>
                        ${notification.message ? `<div class="notification-message">${notification.message}</div>` : ''}
                        <div class="notification-time">${formatTime(notification.timestamp)}</div>
                    `;
                    notificationDropdown.appendChild(notificationItem);
                    
                    // Mark as read when clicked
                    notificationItem.addEventListener('click', function() {
                        if (!notification.read) {
                            notification.read = true;
                            localStorage.setItem('pcea_notifications', JSON.stringify(notifications));
                            loadNotifications();
                        }
                    });
                });
            }
        }

        function addNotification(title, message, type, excludeEmail) {
            const newNotification = {
                id: Date.now(),
                title: title,
                message: message,
                type: type,
                read: false,
                timestamp: new Date().toISOString(),
                exclude: excludeEmail || null
            };
            
            notifications.push(newNotification);
            localStorage.setItem('pcea_notifications', JSON.stringify(notifications));
            
            // Reload notifications to update count
            if (currentUser && excludeEmail !== currentUser.email) {
                loadNotifications();
            }
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function formatTime(timestamp) {
            const now = new Date();
            const notificationTime = new Date(timestamp);
            const diffMs = now - notificationTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return formatDate(timestamp);
        }
    </script>
</body>
</html>